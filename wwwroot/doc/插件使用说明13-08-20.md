#插件的构成

首先，我们插件的定位是用于实现某些简单的显示及数据处理的功能扩展。所以我们的初衷是插件的开启关闭，不会影响原有数据。

其次，插件存放的位置是wwwroot/Addons/相应插件名 的一个目录。

然后，一个完整的插件应当包含至少3个文件:

1. info.php - 插件信息文件
2. config.php - 插件配置文件（可选） info和config目前用文件存储的，以后可能直接写在类里。
3. 插件名Addons.class.php文件 - 插件功能实现文件
4. XXX.html  - 插件模板文件，为了简单实现，没有用复杂的目录结构，当然如果你使用目录结构使得目录有层次感，也可建立父目录， 在功能实现的方法里 `$this->display('目录/模板')` 也可以用。(可选)

最后，资源文件 大家应当 先考虑系统里有了什么，不需要的放进来，为了部署的方便，安装时通过install方法 移动到Public目录下, 然后在你的模板里用`__STATIC__`引入。 这个目录在/Public/static下

#插件的开发

我们以Editor插件来做示范。

首先明确插件的用途：用于增强系统长文本内容的发布显示，名字就叫Editor好了。

所以，我们第一步，在插件总目录Addons下建立Editor目录，然后建立了info.php

内容如下：

	<?php
	return array(
		'name'=>'Editor',
		'title'=>'编辑器',
		'description'=>'用于增强整站长文本的输入和显示',
		'status'=>1,
		'author'=>'thinkphp',
		'version'=>'0.1'
	);

以上里面的字段分别对应了后台插件列表里的名称（title）、标识(name)、描述(description)、状态（安装好后的初始status1-启用，0-禁用）、作者（author thinkphp是代表官方的）、版本(version)

这些信息会在安装的时候写入Addons表，用于后台显示和进行操作。

再次，我们这个插件可以配置某些类型（如：纯文本、富文本、ubb、markdown）、有可能会对样式做控制。因此我们需要一个配置页面。

为了方便大家开发，并保持后台管理界面的一致性。我在后台的/wwwroot/Application/Admin/View/Addons 里放了一个config.html。动态读取生成配置管理页面。
大家只要定一些数组，就能生成常用的表单。

Editor的 config.php 的内容：

	<?php
	return array(
		'editor_type'=>array(               //editor_type是表单的name，加了前缀防冲突
			'title'=>'编辑器类型:',         //表单前显示的中文名
			'type'=>'select',			    //表单的类型和html一致
			'options'=>array(				//下拉、checkbox、radio有多个值的表单选项数据
				'1'=>'普通文本',			//选项值
				'2'=>'富文本',				//选项显示文本
				'3'=>'UBB解析',
				'4'=>'Markdown编辑器'
			),
			'value'=>'1',					//表单默认值
		),
		'editor_height'=>array(
			'title'=>'编辑器高度:',
			'type'=>'text',
			'value'=>'500px'
		)
	);

就是一个返回配置项的数组 结构上面注释有说明

最后定义了插件的实现,代码很简单 EditorAddons.class.php 的内容：

	<?php
// +----------------------------------------------------------------------
// | ThinkPHP [ WE CAN DO IT JUST THINK IT ]
// +----------------------------------------------------------------------
// | Copyright (c) 2006-2012 http://thinkphp.cn All rights reserved.
// +----------------------------------------------------------------------
// | Author: yangweijie <yangweijiester@gmail.com> <code-tech.diandian.com>
// +----------------------------------------------------------------------

/**
 * 编辑器插件
 * @author yangweijie <yangweijiester@gmail.com>
 */

	class EditorAddons extends Addons{

		public function install(){
			return true;
		}

		public function uninstall(){
			return true;
		}

		/**
		 * 编辑器挂载的文章内容钩子
		 * @param array('name'=>'表单name','value'=>'表单对应的值')
		 */
		public function documentEditFormContent($data){
			$this->assign('data', $data);
			$this->assign('config', $this->getConfig());
			$this->display('content');
		}
	}


	插件类必须是XXXAddons类名 继承Addons基类,并且必须实现install 和uninstall两个抽象方法，在这两个方法里实现安装卸载过程中想做的操作。
	并且必须有返回值告诉2步里是否成功了。

	然后关键是实现钩子的方法 documentEditFormContent 参数可选只有一个，并且在系统响应文字里传过来。当执行hooks('document_edit_form_content',2,$param)时会被调用。

	并且这个钩子的插件实现方法只能进行数据处理或者显示输出。显示和之前的action差不多，因为我们实现了action里的部分方法。

	讲到这我们说下插件的整个流程：

	部署代码包->安装插件（这时会Addons表写入插件信息和初始配置信息向相应的钩子表加入实现的钩子的插件信息-同hook名的addons字段的添加如Editor,','分割的字符串）->启用插件->配置、运行插件、卸载插件（卸载插件处的钩子数据addons字段-主表数据删除）

	其中配置 只会存一下数据的信息json保存 。如 {editor_type:1,editor_width:'500px'}等。

	然后整个基类有一些公用方法和属性：

	*. addon_path 插件目录
	*. config_file 配置文件路径
	*. theme、display、assign、fetch
	*. getName 获取的是插件原名如Editor
	*. getConfig 获取插件的配置，并合并了状态status方便大家以后使用

#未实现的

1. 插件的安装时代码符合规范的检测
2. 系统钩子的对应插件的排序功能，等前端完成js部分。
3. url 访问的限制  目前解决方案是在插件目录里建立Controller目录 和相应控制器继承action，用户自己去创建的方法就能通过addons_url()访问

#补充
插件用到的函数hooks(钩子名、类型(1-无模板，2-模板类),参数)

addons(插件名如Editor) 返回插件类的实例化

addons_url(url,参数)用于生成在addons里定义Controller访问的url 这个对应的前台addosn/execute方法要修改



