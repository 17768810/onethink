<h1 >权限相关功能开发指导</h1>

<h2 >全局权限配置</h2>

<blockquote>
  <p >全局权限配置指不分级别对所有管理员用户生效的配置</p>
</blockquote>

<h3 >deny静态属性</h3>

<blockquote>
  <p >保存禁止所有管理员访问的公共方法,这些公共方法通常供A函数从内部调用</p>
</blockquote>

<p >例如: AuthManager控制器中有一个方法updateRules用于更新系统的菜单,不允许通过url访问,这个方法是供System控制器中的缓存管理方法使用的,所以必须设置为 public</p>

<pre class='lang'><code>static protected $deny  = array('updateRules');
</code></pre>

<h3 >allow静态属性</h3>

<blockquote>
  <p >保存允许所有管理员访问的公共方法</p>
</blockquote>

<p >例如: 检测系统新版本,获取官方rss新闻等功能,是允许任何管理员登陆后可用的,无需配置权限节点</p>

<pre class='lang'><code>static protected $allow = array('rss','version_check');
</code></pre>

<h2 >菜单权限控制</h2>

<blockquote>
  <p >菜单权限指登陆后台后可进入的后台区域,这些页面系统安装后即始终存在,所以可以直接在控制器中定义$nodes属性,权限系统将根据该属性
  自动为不同权限的管理员返回对应权限的后台界面菜单,任何非授权的访问将被拒绝.</p>
</blockquote>

<h3 >配置格式</h3>

<pre class='lang'><code class='php'>    static protected $nodes= array(

        array('title'=&gt;'权限管理','url'=&gt;'AuthManager/index','group'=&gt;'用户管理',
              'operator'=&gt;array(
                  array('title'=&gt;'编辑','url'=&gt;'AuthManager/editGroup'),
                  array('title'=&gt;'删除','url'=&gt;'AuthManager/changeStatus?method=deleteGroup'),
                  array('title'=&gt;'禁用','url'=&gt;'AuthManager/changeStatus?method=forbidGroup'),
                  array('title'=&gt;'恢复','url'=&gt;'AuthManager/changeStatus?method=resumeGroup'),
              ),
        ),
    );
</code></pre>

<ul>
<li>配置项目的键必须小写</li>
<li>title,url为必选配置,用于生成菜单和执行验证; url配置值格式:<code>Moudle/Action?param1=value1&amp;param2=value2</code></li>
<li>group默认值为"default"</li>
<li>operator为可选,用于页面打开后页面内的操作按钮的权限,元素只需配置title和url</li>
</ul>

<h2 >动态页面权限控制</h2>

<blockquote>
  <p >动态页面指安装系统后,经过后台添加自动生成的页面,例如栏目分类;
  动态页面权限不能写死在控制器中,而是需要在自己的action执行时,进行权限验证.
  因此需要首先建立权限关系记录(例如:使用一个表记录用户组id与有权栏目分类id的对应关系)</p>
</blockquote>

<h3 >验证流程</h3>

<p >访问页面 <code>&gt;</code> 获取用户uid <code>&gt;</code> 根据uid获取用户组id <code>&gt;</code> 读取用户组拥有的相应权限 <code>&gt;</code> 执行判断逻辑</p>

<h3 >栏目分类权限验证</h3>

<blockquote>
  <p >系统已经内置了栏目分类权限验证的功能,栏目与用户组对应关系存储在<code>think_auth_category_access</code>表</p>
  
  <p >系统内置了获取用户拥有访问权限的所有分类id的静态方法:<code>AuthGroupModel::getAuthCategories($uid)</code>,
  该方法返回一个索引数组,包含了用户拥有权限的所有栏目分类的id,你只需要通过ia_array()函数判断当前用户
  访问的栏目id是否在数组中即可完成权限判断</p>
</blockquote>

<h3 >栏目权限设置</h3>

<blockquote>
  <p >系统内置了设置栏目所属用户组的静态方法:<code>AuthGroupModel::addToCategory($gid,$cid)</code></p>
</blockquote>

<ul>
<li>@param intarray $gid   用户组id</li>
<li>@param string|array $cid   分类id</li>
</ul>

<p >示例: 为id为123的用户组设置栏目id为(2,3,5,8,9)的访问权限</p>

<pre class='lang'><code class=''>AuthGroupModel::addToCategory( 123, array(2,3,5,8,9) ); 
AuthGroupModel::addToCategory( 123, '2,3,5,8,9' ); 
</code></pre>

<h2 >动态扩展菜单</h2>

<blockquote>
  <p >在控制器的相关方法中为模板分配一个菜单扩展变量,即可为左侧的菜单动态增加菜单</p>
  
  <p >例如,如果在index操作中增加以下变量,则在访问index操作是左侧便会在"测试组"插入一条"测试链接"菜单,在"用户管理"组插入一条"测试链接2"菜单</p>
  
  <p >你可以把以下代码粘贴到操作中查看效果</p>
</blockquote>

<pre class='lang'><code class=''>        //菜单扩展变量名: _extra_menu
        $this-&gt;assign('_extra_menu',array(
            '测试组'=&gt;array(
                array('title'=&gt;'测试链接','url'=&gt;'AuthManager/index2'),
            ),
            '用户管理'=&gt;array(
                array('title'=&gt;'测试链接','url'=&gt;'AuthManager/index3'),
            )
        ));
</code></pre>
