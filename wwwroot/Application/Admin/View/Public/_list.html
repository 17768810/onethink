<notempty name="_thead">
<php> $operator=array(); </php>
<table class="{$_table_class|default=""}">
    <thead>
        <tr>
        <foreach name="_thead" item="th" key="key">
        <th>
            <if condition="!is_array($th)">
                {$th}
            <elseif condition="strpos($key,'_')===0 " />
                {$th.th}
            <elseif condition="isset($th['title'])" />
                {$th.title}
                <if condition="!isset($th['tag'])">
                <php>$_thead[$key]['tag'] = 'a';</php>
                </if>
            <else />
                {$key}
                <php>$operator[$key]=$th;</php>
            </if>
        </th>   
        </foreach>
        </tr>
    </thead>
    <notempty name="_list">
    <tbody>
        <foreach name="_list" item="row">
        <tr>
            <foreach name="row" item="td" key="key">
            <if condition="array_key_exists($key,$_thead)" >
                    <td>
<?php
                    if( strpos($key,'_')===0 ){
                        $td = preg_replace_callback('/\$(\w+)/',function($matches) use($row) {
                            return ($row[$matches[1]]);
                        },$td);
                        echo $td;
                    }else if( is_array($_thead[$key]) ) { 

                        if ( array_key_exists('func',$_thead[$key]) ) {
                            $_thead[$key]['func'] = preg_replace_callback('/\$(\w+)/',function($matches) use($row) {
                                return ('"'.$row[$matches[1]].'"');
                            },$_thead[$key]['func']);

                            if ( substr($_thead[$key]['func'],-1)!=';' ) {
                                $_thead[$key]['func'].=';';
                            }
                            @eval('$td ='. $_thead[$key]['func'] );
                        }

                        $Doc = new DOMDocument('1.0','utf-8');
                        $ele = $Doc->createElement($_thead[$key]['tag'],$td);

                        foreach ($_thead[$key] as $k=>$v) {
                            if(strtolower($k)!='title' && strtolower($k)!='tag' && strtolower($k)!='func'){
                                $v = preg_replace_callback('/\$(\w+)/',function($matches) use($row) {
                                    return ($row[$matches[1]]);
                                },$v);
                                if( strtolower($k)=='url' || strtolower($k)=='href' ){
                                    $v = U($v);
                                }
                                $ele->setAttribute($k,$v);
                            }
                        }
                        $Doc->appendChild($ele);
                        echo $Doc->saveHTML();
                    }else{
                       echo $td;
                    }
                        ?>
                    </td>
            </if>
            </foreach>
            <foreach name="operator" item="op" key="key">
                <td>
<?php
                    foreach ($op as $k=>$v){
                        if(is_array($v)){

                            if( !isset($v['tag']) ){
                                $v['tag']='a';
                            }
                            $Doc = new DOMDocument('1.0','utf-8');
                            $ele = $Doc->createElement($v['tag'],$k);

                            foreach ($v as $attr=>$value){
                                $value = preg_replace_callback('/\$(\w+)/',function($matches) use($row) {
                                    return ($row[$matches[1]]);
                                },$value);

                                if( strtolower($attr)=='condition'){
                                    $c = eval( 'return '.$value.';' );
                                    if (!$c){
                                        continue 2;
                                    }
                                }
                                if( strtolower($attr)!='tag' && strtolower($attr)!='condition' ){
                                    if( strtolower($attr)=='url' || strtolower($attr)=='href' ){
                                        $value = U($value);
                                    }
                                    $ele->setAttribute($attr,$value);
                                }
                            }
                            $Doc->appendChild($ele);
                            echo $Doc->saveHTML();
                        }else{
                            $v = preg_replace_callback('/\$(\w+)/',function($matches) use($row) {
                                return ($row[$matches[1]]);
                            },$v);
                            $v = U($v);
                            echo "<a href='$v'>".$k.'</a>'.PHP_EOL;
                        }
                    }
                    ?>
                </td>
            </foreach>
        </tr>
        </foreach>
    </tbody>
    </notempty>
</table>
<notempty>
