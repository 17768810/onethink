<!-- 消息栏 
<div class="tips-bar">
	<i class="i-tips"></i>
	<div class="tips-cnt">网站动态趋势，方便您区分注册应用数、主题量、回复量等数据。</div>
	<a class="close" href="javascritpt:;">×</a>
</div>
<! /消息栏 -->

<!-- 标题栏 -->
<div class="title cf">
	<h2>数据备份</h2>
	<div class="tools">
		<button id="exec-sql"><i class="icon-add"></i>运行SQL</button>
	</div>
</div>
<!-- /标题栏 -->

<!-- 应用列表 -->
<div class="data-table">
	<form id="export-form" method="post" action="{:U('export')}">
		<table>
			<thead>
				<tr>
					<th width="48"></th>
					<th>表名</th>
					<th width="120">数据量</th>
					<th width="120">数据大小</th>
					<th width="160">创建时间</th>
					<th width="160">备份状态</th>
					<th width="120">操作</th>
				</tr>
			</thead>
			<tbody>
				<volist name="list" id="table">
					<tr>
						<td class="num">
							<input checked="chedked" type="checkbox" name="tables[]" value="{$table.name}">
						</td>
						<td>{$table.name}</td>
						<td>{$table.rows}</td>
						<td>{$table.data_length}</td>
						<td>{$table.create_time}</td>
						<td class="info">未备份</td>
						<td class="action">
							<a class="backup" href="javascript:;">优化表</a>&nbsp;
							<a class="backup" href="javascript:;">修复表</a>
						</td>
					</tr>
				</volist>
			</tbody>
			<tfoot>
				<tr>
					<td></td>
					<td class="tools" colspan="6">
						<button id="export" type="submit">立即备份</button>
					</td>
				</tr>
			</tfoot>
		</table>
	</form>
</div>
<!-- /应用列表 -->
<script type="text/javascript">
(function($){
	var $form = $("#export-form"), $export = $("#export"), tables;
	$form.submit(function(){
		$export.attr("disabled", true).html("正在发送请求...");
		$.post(
			$form.attr("action"),
			$form.serialize(),
			function(data){
				if(data.status){
					tables = data.tables;
					$export.html(data.info + "开始备份，请不要关闭本页面！");
					backup(data.tab);
				} else {
					$.thinkbox.error(data.info, {"afterHide" : function(){
						$export.attr("disabled", false).html("立即备份");
					}});
				}
			},
			"json"
		);
		return false;
	});

	function backup(tab, status){
		if(!$.isPlainObject(tab)){
			$export.attr("disabled", false).html("备份完成，点击重新备份");
			return;
		}

		status && showmsg(tab.id, "开始备份...(0%)");
		$.get($form.attr("action"), tab, function(data){
			if(data.status){
				showmsg(tab.id, data.info);
				backup(data.tab, tab.id != data.tab.id);
			} else {
				$.thinkbox.error(data.info, {"afterHide" : function(){
					$export.attr("disabled", false).html("立即备份");
				}});
			}
		}, "json");

	}

	function showmsg(id, msg){
		$form.find("input[value=" + tables[id] + "]").closest("tr").find(".info").html(msg);
	}
})(jQuery);
</script>